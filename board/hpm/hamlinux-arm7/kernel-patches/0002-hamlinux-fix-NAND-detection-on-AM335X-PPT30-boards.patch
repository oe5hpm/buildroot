From 19959d96cf051ba2b95394d0fbc493973be122b2 Mon Sep 17 00:00:00 2001
From: Hannes Schmelzer <oe5hpm@oevsv.at>
Date: Wed, 21 Mar 2018 10:00:55 +0100
Subject: [PATCH 2/4] hamlinux: fix NAND detection on AM335X-PPT30 boards

Signed-off-by: Hannes Schmelzer <oe5hpm@oevsv.at>
---
 drivers/memory/omap-gpmc.c | 18 ++++--------------
 1 file changed, 4 insertions(+), 14 deletions(-)

diff --git a/drivers/memory/omap-gpmc.c b/drivers/memory/omap-gpmc.c
index a385a35..e8bf889 100644
--- a/drivers/memory/omap-gpmc.c
+++ b/drivers/memory/omap-gpmc.c
@@ -1970,7 +1970,6 @@ static int gpmc_probe_generic_child(struct platform_device *pdev,
 	int ret, cs;
 	u32 val;
 	struct gpio_desc *waitpin_desc = NULL;
-	struct gpmc_device *gpmc = platform_get_drvdata(pdev);
 
 	if (of_property_read_u32(child, "reg", &cs) < 0) {
 		dev_err(&pdev->dev, "%pOF has no 'reg' property\n",
@@ -2084,19 +2083,6 @@ static int gpmc_probe_generic_child(struct platform_device *pdev,
 		}
 	}
 
-	/* Reserve wait pin if it is required and valid */
-	if (gpmc_s.wait_on_read || gpmc_s.wait_on_write) {
-		unsigned int wait_pin = gpmc_s.wait_pin;
-
-		waitpin_desc = gpiochip_request_own_desc(&gpmc->gpio_chip,
-							 wait_pin, "WAITPIN");
-		if (IS_ERR(waitpin_desc)) {
-			dev_err(&pdev->dev, "invalid wait-pin: %d\n", wait_pin);
-			ret = PTR_ERR(waitpin_desc);
-			goto err;
-		}
-	}
-
 	gpmc_cs_show_timings(cs, "before gpmc_cs_program_settings");
 
 	ret = gpmc_cs_program_settings(cs, &gpmc_s);
@@ -2292,6 +2278,10 @@ static int gpmc_probe(struct platform_device *pdev)
 	if (IS_ERR(gpmc_base))
 		return PTR_ERR(gpmc_base);
 
+#ifndef CONFIG_OMAP_GPMC_DEBUG
+	gpmc_write_reg(GPMC_CONFIG, 0);
+#endif
+
 	res = platform_get_resource(pdev, IORESOURCE_IRQ, 0);
 	if (!res) {
 		dev_err(&pdev->dev, "Failed to get resource: irq\n");
-- 
2.7.4

